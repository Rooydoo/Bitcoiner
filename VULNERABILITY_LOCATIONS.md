# Data Corruption Vulnerability Locations - Quick Reference

## üéØ Critical Code Locations

### BLOCKER Issues

| ID | Severity | File | Lines | Function | Issue |
|---|---|---|---|---|---|
| B-1 | BLOCKER | `main_trader.py` | 644-670 | `_enter_new_position()` | Order executes before DB write |
| B-1 | BLOCKER | `position_manager.py` | 157-176 | `open_position()` | No transaction, DB write can fail |
| B-2 | BLOCKER | `main_trader.py` | 930-1010 | `_enter_pair_position()` | Two orders not atomic, no rollback |
| B-2 | BLOCKER | `main_trader.py` | 1028-1064 | `_close_pair_position()` | Two close orders not atomic |
| B-3 | BLOCKER | `sqlite_manager.py` | 44-100 | `_init_price_db()` | No PRAGMA journal_mode=WAL |
| B-3 | BLOCKER | `sqlite_manager.py` | 111-220 | `_init_trades_db()` | No PRAGMA settings |
| B-3 | BLOCKER | `sqlite_manager.py` | ALL | All `sqlite3.connect()` | No safety config on connections |

### CRITICAL Issues

| ID | Severity | File | Lines | Function | Issue |
|---|---|---|---|---|---|
| C-1 | CRITICAL | `main_trader.py` | 206-248 | `_restore_pair_positions()` | No exchange validation |
| C-2 | CRITICAL | `position_manager.py` | 168 | `open_position()` | `isoformat()` vs INTEGER mismatch |
| C-2 | CRITICAL | `main_trader.py` | 233 | DB timestamp usage | Mix of string/int timestamps |
| C-3 | CRITICAL | `sqlite_manager.py` | 306-374 | All DB methods | New connection per call |
| C-3 | CRITICAL | `telegram_bot_handler.py` | 7-45 | Threading | Concurrent DB access |
| C-4 | CRITICAL | `main_trader.py` | 715-719 | `_partial_close_position()` | No rollback on DB fail |
| C-5 | CRITICAL | `sqlite_manager.py` | 333-374 | `insert_trade()` | Inconsistent error handling |

### HIGH Priority Issues

| ID | Severity | File | Lines | Function | Issue |
|---|---|---|---|---|---|
| H-1 | HIGH | N/A | N/A | Missing feature | No transaction audit log |
| H-2 | HIGH | `main_trader.py` | 1304-1486 | `start()` | No backup on startup |
| H-3 | HIGH | `main_trader.py` | 295-306 | Trade recording | Ignores returned trade_id |
| H-4 | HIGH | `sqlite_manager.py` | 115-133 | Schema | No FOREIGN KEY constraints |
| H-5 | HIGH | `sqlite_manager.py` | 59, 155 | Timestamp usage | 32-bit overflow risk |
| H-6 | HIGH | `position_manager.py` | 36 | Position ID | No UUID validation |
| H-7 | HIGH | `position_manager.py` | 128 | `open_positions` | No threading.Lock |
| H-8 | HIGH | `main_trader.py` | 1316-1429 | `start()` | Health check only hourly |

---

## üìç Exact Code Snippets (Vulnerable)

### B-1: Non-Atomic Position Creation

**File:** `/home/user/Bitcoiner/main_trader.py`
**Lines:** 644-670

```python
# VULNERABLE CODE - Line 644
order = self.order_executor.create_market_order(
    symbol,
    'buy' if side == 'long' else 'sell',
    quantity
)

if order and order['status'] in ['closed', 'filled']:
    # üí• CRASH HERE = Position lost
    position = self.position_manager.open_position(
        symbol=symbol,
        side=side,
        entry_price=current_price,
        quantity=quantity
    )
```

**Risk:** If crash occurs between line 646 and 654, order is executed but not recorded.

---

### B-2: Non-Atomic Pair Trading

**File:** `/home/user/Bitcoiner/main_trader.py`
**Lines:** 930-960

```python
# VULNERABLE CODE - Line 934
if position.direction == 'long_spread':
    order1 = self.order_executor.create_market_order(position.symbol1, 'buy', position.size1)
else:
    order1 = self.order_executor.create_market_order(position.symbol1, 'sell', position.size1)

if not order1 or order1.get('status') not in ['closed', 'filled']:
    logger.error(f"‚úó {position.symbol1} Ê≥®ÊñáÂ§±Êïó")
    orders_success = False

# üí• CRASH HERE = Only order1 executed, order2 never happens
if orders_success:
    if position.direction == 'long_spread':
        order2 = self.order_executor.create_market_order(position.symbol2, 'sell', position.size2)
    else:
        order2 = self.order_executor.create_market_order(position.symbol2, 'buy', position.size2)
```

**Risk:** Unhedged position if crash between order1 and order2.

---

### B-3: No Database Safety Config

**File:** `/home/user/Bitcoiner/data/storage/sqlite_manager.py`
**Lines:** 44-100

```python
# VULNERABLE CODE - Line 44
def _init_price_db(self):
    conn = sqlite3.connect(self.price_db)  # ‚ùå No safety settings!
    cursor = conn.cursor()

    # Creates tables...
    # ‚ùå No PRAGMA journal_mode=WAL
    # ‚ùå No PRAGMA synchronous=FULL
    # ‚ùå No PRAGMA foreign_keys=ON
```

**Risk:** Database corruption on power loss or crash.

---

### C-1: No Position Reconciliation

**File:** `/home/user/Bitcoiner/main_trader.py`
**Lines:** 206-248

```python
# VULNERABLE CODE - Line 209
def _restore_pair_positions(self):
    try:
        open_positions = self.db_manager.get_open_pair_positions()

        # ‚ùå Never checks actual exchange positions
        for pos_data in open_positions:
            position = PairPosition(...)  # Blindly trusts DB
            self.pair_trading_strategy.positions[position.pair_id] = position
```

**Risk:** Managing positions that no longer exist on exchange.

---

### C-2: Timestamp Type Mismatch

**File:** `/home/user/Bitcoiner/trading/position_manager.py`
**Lines:** 162-171

```python
# VULNERABLE CODE - Line 162
position_data = {
    'position_id': position.position_id,
    'symbol': symbol,
    'side': side,
    'entry_price': entry_price,
    'entry_amount': quantity,
    'entry_time': position.entry_time.isoformat(),  # ‚ùå STRING
    'status': 'open'
}
self.db_manager.create_position(position_data)
```

**Database Schema:**
```sql
CREATE TABLE positions (
    entry_time INTEGER NOT NULL,  -- ‚ùå Expects INTEGER!
```

**Risk:** Type mismatch causes errors or corrupted data.

---

### C-3: No Connection Pooling

**File:** `/home/user/Bitcoiner/data/storage/sqlite_manager.py`
**Examples throughout file:**

```python
# Line 306
conn = sqlite3.connect(self.price_db)  # New connection

# Line 343
conn = sqlite3.connect(self.trades_db)  # New connection

# Line 386
conn = sqlite3.connect(self.trades_db)  # New connection
```

**With concurrent access from:**
- Main trading thread
- Telegram bot handler thread (line 7 in `telegram_bot_handler.py`)

**Risk:** Race conditions, "database is locked" errors.

---

### H-7: Unprotected Shared State

**File:** `/home/user/Bitcoiner/trading/position_manager.py`
**Lines:** 128

```python
# VULNERABLE CODE - Line 128
self.open_positions: Dict[str, Position] = {}  # ‚ùå No lock

# Multiple threads access this:
# Thread 1 (main): self.open_positions[symbol] = position
# Thread 2 (telegram bot): position = self.open_positions.get(symbol)
```

**Risk:** Race condition, data corruption in dict.

---

## üîç Search Patterns to Find Issues

Use these grep commands to audit the code:

### Find all database writes without transactions
```bash
grep -n "conn.commit()" data/storage/sqlite_manager.py
# Check if each has try/except with rollback
```

### Find all order executions
```bash
grep -rn "create_market_order\|create_limit_order" --include="*.py"
# Check if followed by DB write
```

### Find all sqlite3.connect calls
```bash
grep -rn "sqlite3.connect" --include="*.py"
# Check if PRAGMA settings applied
```

### Find all timestamp conversions
```bash
grep -rn "isoformat\|timestamp\(\)" --include="*.py"
# Check for consistency (int vs string)
```

### Find all threading usage
```bash
grep -rn "threading\|Thread\|Lock" --include="*.py"
# Check if shared resources are protected
```

---

## üß™ Crash Scenario Test Script

**File:** `/home/user/Bitcoiner/tests/test_crash_scenarios.sh`

```bash
#!/bin/bash

echo "=== CRASH SCENARIO TESTING ==="

# Test 1: Kill during position open
test_position_open_crash() {
    echo "Test 1: Crash during position open"

    python3 main_trader.py --test &
    TRADER_PID=$!

    sleep 30  # Wait for trading to start

    # Kill hard (simulate crash)
    kill -9 $TRADER_PID

    # Check database
    sqlite3 database/trades.db <<SQL
        SELECT COUNT(*) as pending FROM positions WHERE status = 'pending';
        SELECT COUNT(*) as orphaned FROM positions
        WHERE position_id NOT IN (SELECT DISTINCT position_id FROM trades WHERE position_id IS NOT NULL);
SQL

    echo "‚úì Test 1 complete"
}

# Test 2: Database locked scenario
test_database_lock() {
    echo "Test 2: Concurrent database access"

    # Open long-running connection
    sqlite3 database/trades.db "BEGIN TRANSACTION; SELECT * FROM positions;" &
    LOCK_PID=$!

    sleep 1

    # Try to write (should handle locked database)
    timeout 5 python3 -c "
from data.storage.sqlite_manager import SQLiteManager
db = SQLiteManager()
try:
    db.create_position({
        'position_id': 'test_lock',
        'symbol': 'BTC/JPY',
        'side': 'long',
        'entry_price': 1000000,
        'entry_amount': 0.01,
        'entry_time': 1234567890,
        'status': 'open'
    })
    print('SUCCESS - handled locked database')
except Exception as e:
    print(f'FAILED - {e}')
"

    kill $LOCK_PID 2>/dev/null

    echo "‚úì Test 2 complete"
}

# Test 3: Verify WAL mode
test_wal_mode() {
    echo "Test 3: Verify WAL mode enabled"

    WAL_STATUS=$(sqlite3 database/trades.db "PRAGMA journal_mode;")

    if [ "$WAL_STATUS" = "wal" ]; then
        echo "‚úì WAL mode enabled"
    else
        echo "‚úó WAL mode NOT enabled (currently: $WAL_STATUS)"
        exit 1
    fi
}

# Test 4: Database integrity
test_integrity() {
    echo "Test 4: Database integrity check"

    for db in database/*.db; do
        echo "Checking $db..."
        INTEGRITY=$(sqlite3 "$db" "PRAGMA integrity_check;")
        if [ "$INTEGRITY" = "ok" ]; then
            echo "‚úì $db is intact"
        else
            echo "‚úó $db is CORRUPTED: $INTEGRITY"
            exit 1
        fi
    done
}

# Run all tests
test_position_open_crash
test_database_lock
test_wal_mode
test_integrity

echo ""
echo "=== ALL CRASH SCENARIO TESTS PASSED ==="
```

Make executable:
```bash
chmod +x tests/test_crash_scenarios.sh
```

---

## üìä Impact Summary

| Issue Type | Count | Max Impact | Time to Fix |
|-----------|-------|-----------|-------------|
| BLOCKER | 3 | Data Loss | 2 days |
| CRITICAL | 5 | Inconsistency | 1 day |
| HIGH | 8 | Operational | 3 days |
| **TOTAL** | **16** | **Production Risk** | **~6 days** |

**Additional Time Needed:**
- Testing: 1 week
- Paper trading validation: 1 week
- **Minimum total: 20 days**

---

## ‚úÖ Verification Checklist

After implementing fixes, verify each:

- [ ] Run `test_crash_scenarios.sh` - all pass
- [ ] Check `PRAGMA journal_mode` = "wal" for all DBs
- [ ] Check `PRAGMA foreign_keys` = "ON"
- [ ] Verify no "database is locked" errors in logs
- [ ] Test position recovery after hard kill
- [ ] Test pair position recovery
- [ ] Manual reconciliation procedure documented
- [ ] 1 week paper trading with no data issues
- [ ] Code review by second developer
- [ ] Final security audit

---

**Last Updated:** 2025-11-22
**Status:** ‚ùå NOT SAFE FOR LIVE TRADING
